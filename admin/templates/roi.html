<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#8b5cf6" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1a1625" media="(prefers-color-scheme: dark)">
    <title>ROI Configuration - FoodInsight Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
    <script src="/static/htmx.min.js"></script>
</head>
<body>
    <!-- Skip to main content link for keyboard users -->
    <a href="#main-content" class="sr-only">Skip to main content</a>

    <header role="banner">
        <nav class="admin-nav" role="navigation" aria-label="Main navigation">
            <div class="admin-nav__brand">
                <span class="admin-nav__logo">FoodInsight</span>
                <span class="admin-nav__subtitle">Edge Admin</span>
            </div>
            <button class="admin-nav__toggle" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="main-navigation">
                <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" focusable="false">
                    <path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                </svg>
            </button>
            <ul class="admin-nav__list" id="main-navigation">
                <li><a href="/" class="admin-nav__link">Dashboard</a></li>
                <li><a href="/roi" class="admin-nav__link admin-nav__link--active" aria-current="page">ROI Config</a></li>
                <li><a href="/status" class="admin-nav__link">Status</a></li>
            </ul>
        </nav>
    </header>

    <main role="main" id="main-content">
        <h1>Configure Detection Region</h1>
        <p>Click and drag to select the snack shelf area. Only this region will be processed for detection.</p>

        <section class="camera-section" aria-labelledby="roi-config-heading">
            <h2 id="roi-config-heading" class="sr-only">Region of Interest Configuration</h2>
            <div id="roi-container" role="img" aria-label="Camera preview for selecting detection region">
                <img id="preview" src="/preview/snapshot" alt="Camera snapshot for ROI configuration">
                <div id="roi-overlay" role="presentation" aria-hidden="true"></div>
            </div>

            <div>
                <div id="coordinates" aria-live="polite" aria-atomic="true">
                    <span class="sr-only">Selected region coordinates: </span>
                    <span id="roi-coords">Click and drag to select</span>
                </div>

                {% if roi %}
                <div class="current-roi" role="status">
                    <strong>Current ROI:</strong> ({{ roi.x1 }}, {{ roi.y1 }}) to ({{ roi.x2 }}, {{ roi.y2 }})
                </div>
                {% endif %}

                <div class="controls">
                    <button id="save-btn" class="btn-primary" aria-label="Save region of interest configuration">Save Configuration</button>
                    <button id="reset-btn" class="btn-secondary" aria-label="Reset region of interest to full frame">Reset to Full Frame</button>
                </div>

                <div id="message" role="alert" aria-live="assertive"></div>

                <nav class="nav-links" aria-label="Page navigation">
                    <a class="nav-link" href="/" aria-label="Return to dashboard">Back to Dashboard</a>
                </nav>
            </div>
        </section>
    </main>

    <!-- Toast Notification Container -->
    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script>
        let startX, startY, isDrawing = false;
        let roiX1, roiY1, roiX2, roiY2;
        const container = document.getElementById('roi-container');
        const overlay = document.getElementById('roi-overlay');
        const preview = document.getElementById('preview');
        const coordsDisplay = document.getElementById('roi-coords');
        const messageEl = document.getElementById('message');

        preview.addEventListener('mousedown', (e) => {
            const rect = preview.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            isDrawing = true;
            overlay.style.display = 'block';
            overlay.style.left = startX + 'px';
            overlay.style.top = startY + 'px';
            overlay.style.width = '0px';
            overlay.style.height = '0px';
        });

        preview.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            const rect = preview.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;

            const left = Math.min(startX, currentX);
            const top = Math.min(startY, currentY);
            const width = Math.abs(currentX - startX);
            const height = Math.abs(currentY - startY);

            overlay.style.left = left + 'px';
            overlay.style.top = top + 'px';
            overlay.style.width = width + 'px';
            overlay.style.height = height + 'px';

            updateCoordinates(left, top, left + width, top + height);
        });

        preview.addEventListener('mouseup', (e) => {
            isDrawing = false;
        });

        function updateCoordinates(x1, y1, x2, y2) {
            // Scale from display to actual frame coordinates
            const scale = preview.naturalWidth / preview.clientWidth;
            roiX1 = Math.round(x1 * scale);
            roiY1 = Math.round(y1 * scale);
            roiX2 = Math.round(x2 * scale);
            roiY2 = Math.round(y2 * scale);

            coordsDisplay.textContent = `(${roiX1}, ${roiY1}) to (${roiX2}, ${roiY2})`;
        }

        function showMessage(text, type) {
            messageEl.textContent = text;
            messageEl.className = type;
            setTimeout(() => {
                messageEl.className = '';
            }, 3000);
        }

        // Toast notification helper function
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast--${type}`;
            toast.textContent = message;

            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        document.getElementById('save-btn').addEventListener('click', async () => {
            if (!roiX1 && roiX1 !== 0) {
                showToast('Please draw a region first', 'error');
                return;
            }

            try {
                const response = await fetch('/roi', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({x1: roiX1, y1: roiY1, x2: roiX2, y2: roiY2})
                });
                const data = await response.json();

                if (data.status === 'ok') {
                    showToast('ROI saved successfully!', 'success');
                } else {
                    showToast(data.message || 'Failed to save', 'error');
                }
            } catch (e) {
                showToast('Error saving ROI: ' + e.message, 'error');
            }
        });

        document.getElementById('reset-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/roi/reset', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await response.json();

                if (data.status === 'ok') {
                    overlay.style.display = 'none';
                    coordsDisplay.textContent = 'Full frame (no ROI)';
                    showToast('ROI reset to full frame', 'success');
                } else {
                    showToast(data.message || 'Failed to reset', 'error');
                }
            } catch (e) {
                showToast('Error resetting ROI: ' + e.message, 'error');
            }
        });

        // Refresh snapshot periodically
        setInterval(() => {
            if (!isDrawing) {
                preview.src = '/preview/snapshot?' + Date.now();
            }
        }, 5000);

        // Mobile menu toggle
        document.querySelector('.admin-nav__toggle')?.addEventListener('click', function() {
            const nav = document.querySelector('.admin-nav__list');
            const isOpen = nav.classList.toggle('is-open');
            this.setAttribute('aria-expanded', isOpen);
        });
    </script>
</body>
</html>
